name: Camera Endurance Test

on:
  schedule:
    - cron: '0 22 * * *'  # 毎日22:00にプロセスを開始します
  workflow_dispatch:
    inputs:
      yaml_file:
        description: '読み込むYAMLファイルの名前 (拡張子なし)'
        required: true
        default: 'weekdays'
      build_or_publish:
        description: 'ビルドまたは公開 (build または publish)'
        required: true
        default: 'build'
        type: string

jobs:
  endurance_test_mekiki:
    runs-on: [self-hosted, windows]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref_name }}

      - name: Prepare Mekiki Directory
        run: |
          $projectDir = "C:\CSharp.Hutzper.Library"
          $repositoryUrl = "https://github.com/Hutzper-inc/CSharp.Hutzper.Library.git"
          $branch = '${{ github.ref_name }}'

          # branchがmainのとき、developに変更（のちに変更）
          if ($branch -eq 'main') {
            $branch = 'develop'
          }
          if (-Not (Test-Path $projectDir)) {
            git clone $repositoryUrl $projectDir
          } else {
            Set-Location -Path $projectDir
            git fetch origin
            git checkout $branch
            git pull origin $branch
          }
        shell: powershell

      - name: Build or Publish Project
        run: |
          $operation = '${{ github.event.inputs.build_or_publish }}'
          if ([string]::IsNullOrEmpty($operation)) {
            $operation = 'build'
          }
          $projectFile = "C:\CSharp.Hutzper.Library\Hutzper.Library.FormsMekiki\Hutzper.Project.Mekiki.csproj"

          if ($operation -eq 'build') {
            dotnet build $projectFile -c Release
          } elseif ($operation -eq 'publish') {
            dotnet publish $projectFile -c Release -o "C:\CSharp.Hutzper.Library\publish"
          } else {
            Write-Error "無効なオプションが指定されました。'build' または 'publish' を指定してください。"
            exit 1
          }
        shell: powershell

      - name: Parse YAML File and Write to JSON
        run: |
          $yamlFileName = '${{ github.event.inputs.yaml_file }}.yml'
          $yamlFilePath = "C:\CSharp.Hutzper.Library\test_endurance\$yamlFileName"
          $jsonOutputPath = "C:\CSharp.Hutzper.Library\test_endurance\Parsing_result.json"

          # C#アプリケーションでYAMLファイルをJSONに変換
          dotnet run --project C:\CSharp.Hutzper.Library\YamlParser.csproj -- $yamlFilePath $jsonOutputPath

          # 結果を表示
          Get-Content $jsonOutputPath
        shell: powershell

      - name: Run Camera Tests
        run: |
          $configFilePath = "C:\CSharp.Hutzper.Library\test_endurance\Parsing_result.json"
          if (-Not (Test-Path $configFilePath)) {
            Write-Error "設定ファイル '$configFilePath' が存在しません。"
            exit 1
          }

          $configContent = Get-Content $configFilePath | Out-String
          $cameraSettings = $configContent | ConvertFrom-Json

          $results = @()
          foreach ($camera in $cameraSettings.cameras) {
            Write-Output "カメラ: $($camera.name)"
            Write-Output "テスト時間: $($camera.duration_minutes) 分"
            $processName = "Hutzper.Project.Mekiki"
            $startTime = Get-Date
            $endTime = $startTime.AddMinutes($camera.duration_minutes)

            Write-Output "カメラ $($camera.name) のテストを開始します。"
            while ((Get-Date) -lt $endTime) {
              Start-Sleep -Seconds 5
              $process = Get-Process -Name $processName -ErrorAction SilentlyContinue
              if (-Not $process) {
                $deadTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                Write-Output "プロセスが $deadTime に停止しました。"
                $results += "$($camera.name): Failure"
                continue
              }
            }
            Write-Output "カメラ $($camera.name) のテストが完了しました。"
            $results += "$($camera.name): Success"
          }

          # 結果を保存
          $results | Out-File -FilePath "C:\CSharp.Hutzper.Library\test_endurance\test_results.txt"
          Write-Output "結果が 'test_results.txt' に保存されました。"
        shell: powershell

      - name: Notify GitHub Actions of Result
        run: |
          Write-Output "テスト結果: 成功"
        shell: powershell
